# Tuya Smart Plug Exporter example configuration
# Tip:
# - Keep autodiscovery enabled on first run
# - After confirming DPS keys and scales, set them manually per device
# - Then disable autodiscovery for stable production metrics

web:
  listen_address: "0.0.0.0:9122"   # HTTP bind address for the exporter
  telemetry_path: "/metrics"       # Prometheus metrics path

scrape:
  timeout_seconds: 3.0             # Per-device request timeout
  max_parallel: 8                  # Max devices scraped in parallel
  stale_seconds: 300               # Hide consumption metrics if older than this
  poll_interval_seconds: 10        # Poll interval for all devices
  ready_grace_seconds: 30          # /readyz stays ready if last poll is within this window

  inferred_on_power_w: 3.0         # Relay inferred ON if power >= this
  inferred_off_power_w: 1.5        # Relay inferred OFF if power <= this
  inferred_on_current_a: 0.03      # Relay inferred ON if current >= this
  inferred_off_current_a: 0.015    # Relay inferred OFF if current <= this

tuya:
  versions: [3.4, 3.3, 3.2, 3.1, 3.0]   # Versions tried for protocol detection (in order)

autodiscovery:
  enabled: true                   # Recommended for first run / onboarding
  threshold: 0.85                 # Confidence threshold for voltage/power/current mapping
  relay_threshold: 0.60           # Confidence threshold for relay DPS detection
  samples: 4                      # Number of recent samples used for inference
  tol_rel: 0.30                   # Relative error tolerance for P ~= V * I checks
  min_power_w: 8.0                # Ignore near-idle samples when inferring power mapping
  min_current_a: 0.05             # Ignore near-idle samples when inferring current mapping
  probe_dps: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]

devices:
  - name: "plug-1"                # Friendly label used in metrics
    ip: "192.168.0.50"            # Device local IP
    device_id: "REPLACE_DEVICE_ID_1"
    local_key: "REPLACE_LOCAL_KEY_1"

    # Optional: force protocol version if auto-detection is slow or unstable
    # version: 3.4

    # Optional: manual DPS mapping (recommended after first successful autodiscovery)
    # dps:
    #   relay: "1"
    #   current: "18"
    #   power: "19"
    #   voltage: "20"

    # Optional: manual scaling divisors for the selected DPS keys
    # Example commonly seen on some plugs:
    # - current 54 -> 54 mA -> 0.054 A  => divide by 1000
    # - power   46 -> 4.6 W             => divide by 10
    # - voltage 2157 -> 215.7 V         => divide by 10
    # scale:
    #   current: 1000
    #   power: 10
    #   voltage: 10

  - name: "plug-2"
    ip: "192.168.0.51"
    device_id: "REPLACE_DEVICE_ID_2"
    local_key: "REPLACE_LOCAL_KEY_2"

    # version: 3.4
    # dps:
    #   relay: "1"
    #   current: "18"
    #   power: "19"
    #   voltage: "20"
    # scale:
    #   current: 1000
    #   power: 10
    #   voltage: 10
